<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ZXC - AppQuimica3</title>
    <script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html { font-family:'Inter',sans-serif; -webkit-tap-highlight-color:transparent; }
        :root { --bg: #1f2937;--txt: #f3f4f6;--surf: #374151;--p-soft: #60a5fa;--th: #374151; }
        .light-mode { --bg: #f9fafb; --txt: #111827; --surf: #ffffff; } 
        body { background-color: var(--bg); color: var(--txt); transition: background .3s, color .3s; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        #app-container { width:100%; min-height:100vh; display:flex; flex-direction:column; box-shadow:0 0 20px rgba(0,0,0,.2); position:relative; background-color: var(--bg); transition: max-width 0.3s ease-in-out; }
        .mode-mobile { max-width:500px; }
        .mode-desktop { max-width:100%!important; }
        header, footer { width:100%; max-width:inherit; z-index:50; position:fixed; background:var(--surf); border-color:#4b5563; left: auto; right: auto; transform: none; }
        header { top:0; height:3.5rem; display:flex; align-items:center; border-bottom:1px solid; }
        footer { bottom:0; height:3.5rem; display:flex; align-items:center; border-top:1px solid; border-color:#4b5563; }
        header, .footer-tienda { background: #374151 !important; color: #f3f4f6 !important; border-color: #4b5563 !important;}
        main { flex-grow:1; overflow-y:auto; padding:76px 1rem 80px; width: 100%; box-sizing: border-box; }
        .footer-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:.75rem; color:var(--txt); cursor:pointer; flex: 1; }
        .footer-btn.active { color:var(--p-soft); font-weight:700; }
        .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.8); backdrop-filter:blur(4px); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--surf); border:1px solid #4b5563; border-radius:1rem; width:90%; max-width:320px; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
        <style>    
        /* Buscador */
         .search-actions-container { display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; width: 100%; }
        .search-input-wrapper { position: relative; flex-grow: 1; border-radius: 0.75rem; }      
        .search-input-wrapper input { width: 100%; padding: 0.5rem 1rem 0.5rem 2.5rem; border-radius: 0.75rem; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06); background-color: #374151; color: #f3f4f6; border: 1px solid #4b5563; transition: border-color 0.15s, box-shadow 0.15s; outline: none; }
        .search-input-wrapper input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .search-highlight { background-color: rgba(59, 130, 246, 0.4); color: #ffffff; border-radius: 2px; padding: 0 2px; font-weight: bold; }
        /* Tabla de Datos */
        .table-scroll-container { max-height: calc(100vh - 340px); min-height: 180px; overflow: auto; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: block; border: 1px solid #4b5563; }
        .table-scroll-container table { border-collapse: collapse; table-layout: auto; width: max-content; min-width: 100%; }
        .table-scroll-container th { color: #137be2; position: sticky; top: 0; z-index: 20; background-color: var(--th); padding: 0.25rem 0.5rem; text-align: center; white-space: nowrap; font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.2); cursor: pointer; text-transform: uppercase; }
        .sticky-id-cell { position: sticky; left: 0; z-index: 40; font-weight: bold; text-align: center; border-right: 1px solid rgba(255,255,255,0.2); background-color: var(--th); }
        .table-data-cell { height: 24px; font-size: 0.75rem; padding: 0.25rem 0.5rem; white-space: nowrap; transition: background-color 0.15s; border-bottom: 1px solid #4b5563; }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .row-warning-text .table-data-cell { color: #fcd34d; }
        .row-alert-text .table-data-cell { background-color: #582b2b; color: #fca5a5; font-weight: 600; }
        #table-selector { appearance: none; -webkit-appearance: none; padding-right: 20px; background-repeat: no-repeat; background-position: right center; background-size: 14px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); }
        #table-selector option { font-size: 14px; padding: 12px; background-color: #1f2937; color: white; }
        th { white-space: normal !important; line-height: 1.2; vertical-align: middle; padding: 8px 4px; max-width: 126px; min-width: 20px;}
        /* Ajuste para rotación Landscape */
        @media (orientation: landscape) and (max-height: 500px) { 
            main { padding: 64px 0.5rem 64px; } 
            .table-scroll-container { max-height: calc(100vh - 200px); } 
            #data-view-container .flex.p-4 { display: none; } /* Oculta métricas en horizontal para dar espacio a la tabla */
        }
/* 1. Columna # Fija Horizontalmente */
/* Asegurar que el encabezado fijo esté por encima de las celdas fijas al hacer scroll vertical */
thead th.sticky-id-cell {
    z-index: 60;
}

/* 2. Cuadrícula Horizontal (Líneas entre filas) */
#main-table {
    border-collapse: collapse; /* Importante para que los bordes se vean bien */
}

#main-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Línea muy sutil */
}



    </style>
    </head>
<body class="dark">
    <div id="app-container" class="mode-mobile shadow-xl">
        <header class="top-0 h-14 border-b flex items-center justify-between px-6">
            <h1 class="text-xl font-bold text-white truncate mr-2">Cargando...</h1>
            <div class="flex items-center gap-3">
                <button class="p-2" onclick="toggleView()"><div id="view-icon-container"></div></button>
                <button class="p-2 text-red-400 rounded-full hover:bg-gray-600" onclick="logout()"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </div>
        </header>

        <main id="main-content">
            <div id="scroll-container" class="flex flex-col">
                <div id="search-container" class="search-actions-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="search-input" placeholder="Buscar por Elemento, Símbolo,..."
                            class="w-full rounded-xl shadow-inner text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500"
                            autocomplete="off">
                        <i data-lucide="search" class="search-icon w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                    </div>
                    <button id="clear-search-btn" class="p-2.5 rounded-full text-red-500 hover:bg-gray-700 transition duration-150" title="Reiniciar Filtros y Ordenación">
                        <i data-lucide="x-circle" class="w-8 h-8"></i>
                    </button>
                    <button id="reload-icon" class="p-2 rounded-full text-blue-400 hover:bg-gray-700 transition duration-150" title="Recargar Datos (Omitir Caché)">
                        <i data-lucide="refresh-cw" class="w-8 h-8"></i>
                    </button>
                </div>
                
                <div id="data-table-wrapper" class="mt-8 flex-grow relative min-h-[400px]">
                    <div id="global-loader" class="hidden absolute inset-0 z-[50] flex items-center justify-center rounded-xl">
                        <div class="flex flex-col items-center p-8 bg-gray-800/95 border border-blue-500/40 rounded-2xl shadow-2xl max-h-[40%] h-[400px] min-w-[260px] max-w-[90%] transform -translate-y-4">
                            <div class="relative mb-4">
                                <i data-lucide="loader-2" class="w-10 h-10 text-blue-400 animate-spin"></i>
                            </div>
                            <span class="text-blue-400 font-bold text-sm tracking-wider uppercase text-center">Cargando Base de Datos</span>
                            <p class="text-gray-400 text-[10px] mt-2 text-center leading-relaxed">Sincronizando registros con GAS<br>Por favor, espere.</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700/30">
    
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                            <i data-lucide="layers" class="w-5 h-5 text-blue-400 shrink-0"></i>
                            <div class="relative w-full max-w-[300px]"> 
                                <select id="table-selector" 
                                    class="bg-transparent text-xl font-semibold text-white focus:outline-none cursor-pointer border-none appearance-none pr-8 w-full truncate">
                                    <option value="" disabled selected>Cargando Datos... </option>
                                </select>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 shrink-0 ml-4">
                            <span id="table-status-tag" 
                                class="text-[10px] px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30 uppercase tracking-tighter whitespace-nowrap">
                                Buscando...
                            </span>
                            
                            <div class="h-4 w-[1px] bg-gray-700"></div> <button onclick="showRegisterMode()" 
                                class="text-green-400 hover:scale-110 transition-transform p-1 flex items-center justify-center" 
                                title="Nuevo Registro">
                                <i data-lucide="file-plus-2" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>

                    <div id="data-table-container" class="table-scroll-container"></div>
                </div>
            </div>
        </main>

        <footer id="app-footer" class="bottom-0 h-18 border-t flex items-center justify-around px-2 py-1">
            <button class="footer-btn" data-section="Base"><i data-lucide="house-plus" class="w-6 h-6"></i><span>Base</span></button>
            <button id="btn-datos" class="footer-btn active" data-section="Datos"><i data-lucide="atom" class="w-6 h-6"></i><span>Datos</span></button>
            <button id="btn-agregar" class="footer-btn" data-section="Crear"><i data-lucide="flask-conical" class="w-6 h-6"></i><span>Reacciones</span></button>
            <button class="footer-btn" data-section="Balanceo"><i data-lucide="component" class="w-6 h-6"></i><span>Balanceo</span></button>
        </footer>
    </div>

    <div id="system-modal" class="hidden modal-overlay">
        <div class="modal-content p-6 text-center">
            <div id="sys-modal-icon" class="mb-4 flex justify-center"></div>
            <h3 id="sys-modal-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="sys-modal-text" class="text-gray-400 text-sm mb-6"></p>
            <div id="sys-modal-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-2">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-w-[60vh] max-h-[90vh]">
            
            <div id="modal-header-bg" class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-800/80">
                <div id="detail-modal-title" class="flex items-baseline"></div>
                <button onclick="closeDetailModal()" class="p-2 hover:bg-gray-700/50 rounded-full transition-colors group">
                    <i data-lucide="x" class="w-6 h-6 text-gray-400 group-hover:text-white"></i>
                </button>
            </div>
            <div id="detail-modal-content" class="p-4 overflow-y-auto flex flex-col gap-y-1 text-sm bg-gray-900/50">
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-800/50 flex justify-end">
                <button onclick="closeDetailModal()" class="px-8 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition-all shadow-lg active:scale-95">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

</body>
<script>
    // 1. CONSTANTES Y ESTADO GLOBAL
    const KEYS = {
        NOMBRE: 'Usuario_Nombre',
        CORREO: 'Usuario_Correo',
        VIEW_MODE: 'App_View_Mode',
        THEME: 'App_Theme',
        TIENDA: 'Usuario_Tienda' // Se mantiene para compatibilidad con el GET_URL
    };

    const GET_URL = 'https://script.google.com/macros/s/AKfycby9pl_wwsnq44xd-GxivXlF-Z-MVVH8gJ2zm-enFsErGo17r1RNtsoqaOm9LYEjE-ngJQ/exec';
    const DEFAULT_TABLE_NAME = 'TD101_TPE'; 
    
    let currentTableName = localStorage.getItem('LAST_VISITED_TABLE') || DEFAULT_TABLE_NAME;
    let originalData = []; 
    let tableConfig = { columnOrder: [], displayMap: {}, alignMap: {} };
    let sortConfig = { key: null, direction: null };
    let currentSearchTerm = ""; 

    // 2. INICIALIZACIÓN
    document.addEventListener('DOMContentLoaded', () => {
        if(!localStorage.getItem(KEYS.CORREO)) {
            window.location.replace('index.html');
            return;
        }
        initUI();
        initDataApp();
        setupSearch();
    });

    function initUI() {
        // Saludo personalizado
        const nom = localStorage.getItem(KEYS.NOMBRE);
        if(nom) document.querySelector('h1').textContent = `¡Hola, ${nom.trim().split(/\s+/)[0]}!`;
        
        // Cargar modo de vista (Sincronizado)
        adjustLayoutForOrientation();
        
        // Navegación Footer
        document.querySelectorAll('.footer-btn').forEach(b => {
            b.onclick = () => {
                const NAV = {'Base':'Base3.html','Datos':'AppQuimica3.html'};
                const s = b.getAttribute('data-section');
                if(NAV[s]) window.location.href = NAV[s];
            };
        });

        const btnReload = document.getElementById('reload-icon');
        if(btnReload) btnReload.onclick = () => fetchData(currentTableName);
    }

    function initDataApp() {
        const tiendaIdDisplay = document.getElementById('header-tienda-id');
        const tiendaIdValue = localStorage.getItem(KEYS.TIENDA_ID);
        if (tiendaIdDisplay && tiendaIdValue) tiendaIdDisplay.textContent = tiendaIdValue;
        fetchData(currentTableName);
    }

function logout(){localStorage.clear();window.location.href='index.html'}  

    // 3. GESTIÓN DE VISTA (Mobile/Desktop)
    function adjustLayoutForOrientation() {
        const container = document.getElementById('app-container');
        if (!container) return;
        const isDesktop = window.innerWidth > window.innerHeight;
        const mode = isDesktop ? 'desktop' : 'mobile';   
        localStorage.setItem(KEYS.VIEW_MODE, mode);
        applyViewMode(mode);
    }

    function toggleView() {
        const m = localStorage.getItem(KEYS.VIEW_MODE) === 'desktop' ? 'mobile' : 'desktop';
        localStorage.setItem(KEYS.VIEW_MODE, m);
        applyViewMode(m);
    }

    function applyViewMode(m) {
        const c = document.getElementById('app-container'), i = document.getElementById('view-icon-container');
        if (!c || !i) return;
        
        c.classList.toggle('mode-desktop', m === 'desktop');
        c.classList.toggle('mode-mobile', m !== 'desktop');
        
        i.innerHTML = m === 'desktop' 
            ? '<i data-lucide="smartphone" class="w-5 h-5 text-blue-400"></i>' 
            : '<i data-lucide="monitor" class="w-5 h-5 text-emerald-400"></i>';
            
        if (window.lucide) lucide.createIcons();
    }

    window.addEventListener('resize', adjustLayoutForOrientation);

    // 4. FORMATEO DE DATOS (QUÍMICA)
function getFormattedValue(key, value) {
    // 1. Manejo de nulos o vacíos
    if (value === null || value === undefined || value === '') return '';        
    
    const cleanKey = String(key).toUpperCase();
    let stringValue = String(value).trim();

    // 2. Si el valor es un guion o similar pero queremos que sea numérico, 
    // lo convertimos a "0" para que el formateador lo procese.
    if (stringValue === '-') stringValue = '0';

    // 3. EXCEPCIONES DE TEXTO (Configuración y EO)
    if (cleanKey.includes('CONFIG')) {
        return stringValue.replace(/([spdf])(\d+)/g, '$1<sup>$2</sup>');
    }
    if (cleanKey.substring(5, 7) === 'EO') return stringValue;

    // 4. TRATAMIENTO NUMÉRICO
    const numValue = parseFloat(stringValue.replace(',', '.'));
    
    // IMPORTANTE: !isNaN(numValue) incluirá al 0
    if (!isNaN(numValue) && isFinite(numValue)) {
        const formatOptions = { useGrouping: true, style: 'decimal' };
        
        if (cleanKey.includes('MASA')) {
            return new Intl.NumberFormat('es-ES', { 
                ...formatOptions, 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 5 
            }).format(numValue);
        }

        if (cleanKey.includes('KJ/MOL') || cleanKey.includes('ELECTRONEG.')) {
            return new Intl.NumberFormat('es-ES', { 
                ...formatOptions, 
                minimumFractionDigits: 2, // Forzamos 2 decimales mínimos (0,00)
                maximumFractionDigits: 2 
            }).format(numValue);
        }

        // Formato estándar (ej. Radio atómico, etc.)
        // Si quieres que el 0 general también tenga decimales, cambia minimum a 2
        return new Intl.NumberFormat('es-ES', { 
            ...formatOptions, 
            minimumFractionDigits: (numValue === 0 ? 2 : 0), 
            maximumFractionDigits: 4 
        }).format(numValue);
    }

    return value;
}

    // 5. FETCH Y CARGA DE TABLAS
    async function fetchData(tableName) {
        toggleGlobalLoader(true);
        await loadTableFriendlyNames();
        const userTienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
        const url = `${GET_URL}?tableName=${encodeURIComponent(tableName)}&userTienda=${encodeURIComponent(userTienda)}`;

        try {
            const response = await fetch(url);
            const res = await response.json();

            if (res.success) {
                currentTableName = tableName;
                localStorage.setItem('LAST_VISITED_TABLE', tableName);
                originalData = res.data || [];
                
                // Mapeo de Configuración
                const configArray = res.fullConfig || res.config || [];
                const mappedConfig = {};
                configArray.forEach(item => {
                    mappedConfig[item.ID_Columna] = {
                        label: item.Nombre_Encabezado || item.ID_Columna,
                        visible: item.Visible_Encabezado,
                        align: item.Justificado_Campo || 'left'
                    };
                });
                localStorage.setItem('TABLE_CONFIG', JSON.stringify(mappedConfig));

                // Actualizar UI de Tabla
                tableConfig.columnOrder = res.columnOrder || (originalData.length > 0 ? Object.keys(originalData[0]) : []);
                tableConfig.displayMap = res.displayMap || {};
                tableConfig.alignMap = res.alignMap || {};

                if (res.availableTables) updateTableSelector(res.availableTables);
                
                updateStatusTag(tableName);
                renderTable(originalData);
            }
        } catch (err) {
            console.error("Error fetchData:", err);
        } finally {
            toggleGlobalLoader(false);
        }
    }

    function renderTable(data) {
        const container = document.getElementById('data-table-container');
        if (!container) return;
        
        container.innerHTML = `<table id="main-table"><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>`;
        
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('table-body');
        const tablePrefix = currentTableName.split('_')[0].toUpperCase();
        
        // Numeración
        const thId = document.createElement('th');
        thId.className = 'sticky-id-cell';
        thId.innerHTML = '<span>#</span>';
        tableHeader.appendChild(thId);

        // Encabezados
        tableConfig.columnOrder.forEach(h => {
            const cleanH = h.toUpperCase();
            if (cleanH.endsWith('TYPEREG')) return;

            const th = document.createElement('th');
            const iconName = sortConfig.key === h ? (sortConfig.direction === 'desc' ? 'chevron-down' : 'chevron-up') : 'chevrons-up-down';
            th.innerHTML = `<div class="header-content"><span>${tableConfig.displayMap[h] || h}</span><i data-lucide="${iconName}" class="w-4 h-4 opacity-30"></i></div>`;
            th.onclick = () => handleSort(h);
            tableHeader.appendChild(th);
        });

        // Filas
        data.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.className = 'cursor-pointer hover:bg-blue-500/10 transition-colors';
            tr.ondblclick = () => openDetailModal(row);

            const tdIdx = document.createElement('td');
            tdIdx.className = 'sticky-id-cell text-center';
            tdIdx.textContent = idx + 1;
            tr.appendChild(tdIdx);

            tableConfig.columnOrder.forEach(h => {
                const cleanH = h.toUpperCase();
                if (cleanH.endsWith('TYPEREG')) return;

                const td = document.createElement('td');
                td.className = 'px-3';
                td.style.textAlign = tableConfig.alignMap[h] || 'left';
                const val = getFormattedValue(h, row[h]);
                td.innerHTML = highlightText(val, currentSearchTerm);
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        if (window.lucide) lucide.createIcons();
    }

    // 6. MODAL DE DETALLE (Depurado)
    function openDetailModal(row) {
        const content = document.getElementById('detail-modal-content');
        const title = document.getElementById('detail-modal-title');
        const configMap = JSON.parse(localStorage.getItem('TABLE_CONFIG') || '{}');
        const tablePrefix = currentTableName.split('_')[0].toUpperCase();
        
        content.innerHTML = '';
        
        title.innerHTML = `
            <div class="flex items-baseline gap-3">
                <span class="text-blue-400 text-2xl font-bold">
                    ${row[tablePrefix + 'NOMBRE'] || 'Detalle'}
                </span>
                
                ${row[tablePrefix + 'SIMBOLO'] ? `
                    <div class="flex items-baseline">
                        <span class="text-gray-500 text-3xl font-light">[</span>
                        <span class="text-emerald-400 text-3xl font-black tracking-widest">
                            ${row[tablePrefix + 'SIMBOLO']}
                        </span>
                        <span class="text-gray-500 text-3xl font-light text-baseline">]</span>
                    </div>
                ` : ''}
            </div>
        `;

        Object.keys(row).forEach(key => {
            const cleanKey = key.toUpperCase();
            if (cleanKey.includes('TYPEREG') || cleanKey.includes('ID') || cleanKey.includes('NOMBRE') || cleanKey.includes('SIMBOLO')) return;

            const cfg = configMap[key] || {};
            if (String(cfg.visible).toLowerCase() !== 'x') return;

            const item = document.createElement('div');
            item.className = 'grid grid-cols-[180px_1fr] gap-6 py- border-b border-gray-800/50 last:border-0 hover:bg-white/5 px-2';
            item.innerHTML = `
                <span class="text-gray-500 font-medium uppercase text-[10px] self-center">${cfg.label || key}</span>
                <span class="text-gray-100 font-bold text-sm ${cleanKey.includes('CONFIG') ? 'normal-case' : 'uppercase'}">
                    ${getFormattedValue(key, row[key])}
                </span>`;
            content.appendChild(item);
        });

        document.getElementById('detail-modal').classList.remove('hidden');
        if (window.lucide) lucide.createIcons();
    }

    function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }
    
    // Auxiliares finales
    function toggleGlobalLoader(show) {
        const loader = document.getElementById('global-loader');
        if (loader) loader.classList.toggle('hidden', !show);
    }

function setupSearch() {
    const input = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search-btn'); // Asegúrate de que el ID coincida con tu HTML
    
    if (!input) return;

    // Al escribir
    input.oninput = (e) => {
        currentSearchTerm = e.target.value.toLowerCase();
        applyFiltersAndSort();
    };

    // Al hacer clic en la "X"
    if (clearBtn) {
        clearBtn.onclick = () => {
            input.value = '';
            currentSearchTerm = '';
            applyFiltersAndSort(); // Esto vuelve a renderizar la tabla original
            input.focus();
        };
    }
}

    function highlightText(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return String(text).replace(regex, '<span class="bg-blue-500/30 text-blue-200">$1</span>');
    }

    function handleSort(key) {
        sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'desc') ? 'asc' : 'desc';
        sortConfig.key = key;
        applyFiltersAndSort();
    }

    function applyFiltersAndSort() {
        let data = [...originalData];
        if (currentSearchTerm) {
            data = data.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(currentSearchTerm)));
        }
        if (sortConfig.key) {
            data.sort((a, b) => {
                let vA = a[sortConfig.key], vB = b[sortConfig.key];
                return sortConfig.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
            });
        }
        renderTable(data);
    }

    function updateStatusTag(n) {
        const tag = document.getElementById('table-status-tag');
        if(tag) tag.textContent = n;
    }

function updateTableSelector(tables) {
    const sel = document.getElementById('table-selector');
    if(!sel) return;
    
    sel.innerHTML = tables.map(t => {
        const label = getFriendlyName(t); // Aquí recuperamos el nombre legible
        return `<option value="${t}" ${t === currentTableName ? 'selected' : ''}>${label}</option>`;
    }).join('');
    
    sel.onchange = (e) => fetchData(e.target.value);
}
async function loadTableFriendlyNames() {
    const userTienda = localStorage.getItem(KEYS.TIENDA) || 'DEFAULT';
    try { 
        const r = await fetch(`${GET_URL}?action=getTableFriendlyNames&appTienda=${userTienda}`); 
        const res = await r.json();
        if (res.success) {
            localStorage.setItem('TABLE_FRIENDLY_NAMES', JSON.stringify(res.data));
        }
    } catch (e) { 
        console.error("Error cargando nombres amigables:", e);
    }
}

function getFriendlyName(techName) {
    const namesMap = JSON.parse(localStorage.getItem('TABLE_FRIENDLY_NAMES') || '{}');
    // Si no encuentra el nombre amigable, devuelve el nombre técnico (TD101_TPE)
    return namesMap[techName]?.label || techName;
}
</script>
</body>
</html>
